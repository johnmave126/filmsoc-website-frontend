/**
 * Script File of Film Society, HKUSTSU
 * Author: John Tan <johnmave126@gmail.com>
 * All Rights Reserved
 */

var tz_info="+08:00";function assert(c,b){if(!c){var a="Assertion failed";if(b){a=a+": "+b}throw new Error(a)}}var global=this;function $(a){return document.getElementById(a)}function pad(c,a,b){b=b||"0";c=c+"";return c.length>=a?c:new Array(a-c.length+1).join(b)+c}function url(b){var a=b.replace(/(\(|\)|\,|\s|\'|\"|\\)/g,"\\$1");if(/\\\\$/.test(a)){a+=" "}return'url("'+a+'")'}function parseQueryParams(a){var f={};var c=unescape(a.search.substring(1));var d=c.split("&");for(var b=0;b<d.length;b++){var e=d[b].split("=");f[e[0]]=e[1]}return f}function findAncestorByClass(b,a){return findAncestor(b,function(c){if(c.classList){return c.classList.contains(a)}return null})}function findAncestor(c,a){var b=false;while(c!=null&&!(b=a(c))){c=c.parentNode}return b?c:null}function swapDomNodes(d,c){var f=d.nextSibling;if(f==c){swapDomNodes(c,d);return}var e=d.parentNode;c.parentNode.replaceChild(d,c);e.insertBefore(c,f)}function disableTextSelectAndDrag(b,a){document.onselectstart=function(c){if(!(b&&b.call(this,c))){c.preventDefault()}};document.ondragstart=function(c){if(!(a&&a.call(this,c))){c.preventDefault()}}}function preventDefaultOnPoundLinkClicks(){document.addEventListener("click",function(b){var a=findAncestor(b.target,function(c){return c.tagName=="A"});if(a&&a.getAttribute("href")=="#"){b.preventDefault()}})}function getRequiredElement(b){var a=$(b);assert(a,"Missing required element: "+b);return a}(function(){if(!Element.prototype.matches){if(Element.prototype.webkitMatchesSelector){Element.prototype.matches=Element.prototype.webkitMatchesSelector}else{if(Element.prototype.mozMatchesSelector){Element.prototype.matches=Element.prototype.mozMatchesSelector}else{if(Element.prototype.oMatchesSelector){Element.prototype.matches=Element.prototype.oMatchesSelector}else{if(Element.prototype.msMatchesSelector){Element.prototype.matches=Element.prototype.msMatchesSelector}}}}}assert(Element.prototype.matches,"Unsupported Browser")})();function createElementWithClassName(b,a){var c=document.createElement(b);c.className=a;return c}function extend(c,a){var b=function(){};b.prototype=a.prototype;c.prototype=new b();c.prototype.constructor=c;c.prototype.extend=function(d){assert(this.hasOwnProperty("extend"),"Only prototype callable");for(var e in d){if(d.hasOwnProperty(e)){this[e]=d[e]}}};c.uber=a.prototype}function superCall(a,b){assert(a.uber,"Not a subclass of any class");assert(a.uber[b] instanceof Function,"super class has no functin specified");return a.uber[b].bind(a)}function toISODate(a){return a.replace(" ","T")+".000"+tz_info}function deepCopy(d){if(d==null||typeof(d)!=="object"){return d}if(typeof d.clone=="function"){return d.clone(true)}if(d instanceof Date){return new Date(d.getTime())}if(d instanceof RegExp){return new RegExp(d)}if(d.nodeType&&typeof d.cloneNode=="function"){return d.cloneNode(true)}if(d instanceof Array){return d.slice(0)}var c=(Object.getPrototypeOf?Object.getPrototypeOf(d):d.__proto__);if(!c){c=d.constructor.prototype}var a=Object.create(c);for(var b in d){a[b]=deepCopy(d[b])}return a}(function(){if(!Function.prototype.bind){Function.prototype.bind=function(a){if(typeof this!=="function"){throw new TypeError("Function.prototype.bind - what is trying to be bound is not callable")}var e=Array.prototype.slice.call(arguments,1),d=this,b=function(){},c=function(){return d.apply(this instanceof b&&a?this:a,e.concat(Array.prototype.slice.call(arguments)))};b.prototype=this.prototype;c.prototype=new b();return c}}})();String.prototype.splice=function(a,c,b){return(this.slice(0,a)+b+this.slice(a+Math.abs(c)))};var EventTracker=(function(){function a(){this.listeners_=[]}a.Entry;a.prototype={add:function(e,c,f,b){var d={node:e,eventType:c,listener:f,capture:b};this.listeners_.push(d);e.addEventListener(c,f,b)},remove:function(c,b){this.listeners_=this.listeners_.filter(function(d){if(d.node==c&&(!b||(d.eventType==b))){a.removeEventListener_(d);return false}return true})},removeAll:function(){this.listeners_.forEach(a.removeEventListener_);this.listeners_=[]}};a.removeEventListener_=function(b){b.node.removeEventListener(b.eventType,b.listener,b.capture)};return a})();var global=this;this.cr=(function(){function n(r,p,u){var s=r.split(".");var t=u||global;for(var q;s.length&&(q=s.shift());){if(!s.length&&p!==undefined){t[q]=p}else{if(q in t){t=t[q]}else{t=t[q]={}}}}return t}function g(t,p,s,q){var r=new cr.Event(p+"Change");r.propertyName=p;r.newValue=s;r.oldValue=q;t.dispatchEvent(r)}function c(p){return p.replace(/([A-Z])/g,"-$1").toLowerCase()}var j={JS:"js",ATTR:"attr",BOOL_ATTR:"boolAttr"};function e(q,s){switch(s){case j.JS:var r=q+"_";return function(){return this[r]};case j.ATTR:var p=c(q);return function(){return this.getAttribute(p)};case j.BOOL_ATTR:var p=c(q);return function(){return this.hasAttribute(p)}}}function o(q,s,t){switch(s){case j.JS:var r=q+"_";return function(v){var u=this[q];if(v!==u){this[r]=v;if(t){t.call(this,v,u)}g(this,q,v,u)}};case j.ATTR:var p=c(q);return function(v){var u=this[q];if(v!==u){if(v==undefined){this.removeAttribute(p)}else{this.setAttribute(p,v)}if(t){t.call(this,v,u)}g(this,q,v,u)}};case j.BOOL_ATTR:var p=c(q);return function(v){var u=this[q];if(v!==u){if(v){this.setAttribute(p,q)}else{this.removeAttribute(p)}if(t){t.call(this,v,u)}g(this,q,v,u)}}}}function d(s,p,t,r){if(typeof s=="function"){s=s.prototype}var q=t||j.JS;if(!s.__lookupGetter__(p)){s.__defineGetter__(p,e(p,q))}if(!s.__lookupSetter__(p)){s.__defineSetter__(p,o(p,q,r))}}var f=1;function a(){return f++}function b(p){if(p.hasOwnProperty("uid")){return p.uid}return p.uid=a()}function i(t,r,q,p){var s=new cr.Event(r,q,p);return t.dispatchEvent(s)}function k(t,p){var u=n(t);var r=p();for(var q in r){var s=Object.getOwnPropertyDescriptor(r,q);if(s){Object.defineProperty(u,q,s)}}}function l(p){p.getInstance=function(){return p.instance_||(p.instance_=new p())}}function m(r,q,p){var s=cr.doc.createEvent("Event");s.initEvent(r,!!q,!!p);s.__proto__=global.Event.prototype;return s}function h(){if(!global.document){var p=cr;Object.defineProperty(global,"cr",{get:function(){Object.defineProperty(global,"cr",{value:p});p.initialize();return p},configurable:true});return}m.prototype={__proto__:global.Event.prototype};cr.doc=document}return{addSingletonGetter:l,createUid:a,define:k,defineProperty:d,dispatchPropertyChange:g,dispatchSimpleEvent:i,Event:m,getUid:b,initialize:h,PropertyKind:j}})();cr.initialize();cr.define("cr",function(){function a(){}a.prototype={addEventListener:function(d,c){if(!this.listeners_){this.listeners_=Object.create(null)}if(!(d in this.listeners_)){this.listeners_[d]=[c]}else{var b=this.listeners_[d];if(b.indexOf(c)<0){b.push(c)}}},removeEventListener:function(e,d){if(!this.listeners_){return}if(e in this.listeners_){var b=this.listeners_[e];var c=b.indexOf(d);if(c>=0){if(b.length==1){delete this.listeners_[e]}else{b.splice(c,1)}}}},dispatchEvent:function(g){if(this["on"+g.type]){return this["on"+g.type].call(this,g)}if(!this.listeners_){return true}var c=this;g.__defineGetter__("target",function(){return c});g.preventDefault=function(){this.returnValue=false};var f=g.type;var h=0;if(f in this.listeners_){var b=this.listeners_[f].concat();for(var d=0,e;e=b[d];d++){if(e.handleEvent){h|=e.handleEvent.call(e,g)===false}else{h|=e.call(this,g)===false}}}return !h&&g.returnValue}};return{EventTarget:a}});cr.define("cr.settings",function(){return{resource_base:"http://ihome.ust.hk/~su_film/asset/",api_base:"http://dma005.resnet.ust.hk:49000/film/api/",login_url:"http://dma005.resnet.ust.hk:49000/film/member/login/",logout_url:"http://dma005.resnet.ust.hk:49000/film/member/logout/"}});cr.define("cr.ui.template",function(){var templates={},BBHandler=[{pattern:/\[b\](.+?)\[\/b\]/ig,repl:"<b>$1</b>"},{pattern:/\[i\](.+?)\[\/i\]/ig,repl:"<em>$1</em>"},{pattern:/\[u\](.+?)\[\/u\]/ig,repl:"<u>$1</u>"},{pattern:/\[big\](.+?)\[\/big\]/ig,repl:"<big>$1</big>"},{pattern:/\[small\](.+?)\[\/small\]/ig,repl:"<small>$1</small>"},{pattern:/\[color=([a-zA-Z]*|\#?[0-9a-fA-F]{6})\](.+?)\[\/color\]/ig,repl:'<span style="color:$1">$2</span>'},{pattern:/\[link\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.+?)\[\/link\]/ig,repl:'<a href="$1" rel="nofollow" target="_blank">$2</a>'},{pattern:/\[img\=\s*((?:(?:ftp|https?):\/\/)?(?:(?:[A-Z0-9](?:[A-Z0-9-]{0,61}[A-Z0-9])?\.)+[A-Z]{2,6}\.?|localhost|\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3})(?::\d+)?(?:\/?|[\/?]\S+?))\s*\](.*?)\[\/img\]/ig,repl:'<img src="$1" alt="$2" title="$2">'}];function escapeWrap(value){return"<p>"+value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace(/\n/g,"</p><p>")+"</p>"}function escapePreWrap(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n","<br>")}function escapePre(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeAttr(value){return value.replace(/"/g,"&quot;").replace(/'/g,"&#x27;")}function escapeHTML(value){return value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#x27;").replace("\n"," ")}function escapeBBCode(value){value=escapeWrap(value);for(var i=0;i<BBHandler.length;i++){var dup_value;do{dup_value=value;value=value.replace(BBHandler[i].pattern,BBHandler[i].repl)}while(dup_value!=value)}return value}function render_template(url,param){var template=templates[url],wrapper=document.createElement("div"),item,text,func_head,func_bottom;if(template===undefined){throw new ReferenceError("Undefined template.")}param=param||{};text=template.content||"";var argn=[],args=[];for(var prop in param){if(param.hasOwnProperty(prop)&&/^[_a-zA-Z][_a-zA-Z0-9]*$/.test(prop)){argn.push(prop);args.push("param."+prop)}}func_head="(function("+argn.join(",")+"){ return eval('";func_bottom="');})("+args.join(",")+")";var html=text.replace(/{{(.*?)}}/g,function(m,value){var arg_list,escaper=escapeHTML;value=value.trim();arg_list=value.split("|");if(arg_list[1]){switch(arg_list[1].trim()){case"safe":escaper=function(value){return value};break;case"attr":escaper=escapeAttr;break;case"bbcode":escaper=escapeBBCode;break;case"wrap":escaper=escapeWrap;break;case"pre":escaper=escapePre;break;case"prewrap":escaper=escapePreWrap;break;default:break}}var result=eval(func_head+arg_list[0].trim().replace(/'/g,"\\'")+func_bottom);if(result!=undefined){result=""+result}else{result=""}return escaper(result)});wrapper.innerHTML=html;item=wrapper.firstChild||document.createElement("div");if(template.callback){template.callback.call(item,param)}return item}function globalInitialization(){var pending=[],complete_cnt=0;for(var url in templates){var xhr=new XMLHttpRequest();xhr.open("GET",cr.settings.resource_base+"templates/"+url,true);xhr.onload=(function(url){templates[url].content=this.responseText.trim();complete_cnt++;if(complete_cnt==pending.length){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}).bind(xhr,url);xhr.onerror=function(e){e.recObj={errno:xhr.status,error:""};cr.errorHandler(e)};pending.push(xhr)}for(var i=0;i<pending.length;i++){pending[i].send(null)}if(pending.length===0){cr.dispatchSimpleEvent(window,"moduleload",false,false)}}function register(url,callback){templates[url]={content:null,callback:callback}}function registerBBCode(pattern,repl){assert(pattern instanceof RegExp,"pattern must be RegExp");BBHandler.push({pattern:pattern,repl:repl})}return{globalInitialization:globalInitialization,render_template:render_template,register:register,registerBBCode:registerBBCode,escapeAttr:escapeAttr,escapeBBCode:escapeBBCode}});document.addEventListener("DOMContentLoaded",cr.ui.template.globalInitialization);cr.define("cr",function(){var b=[];function a(f){Object.defineProperty(this,"name",{value:f});this._cache={};this.fields=[]}function e(f,j,g,i){var h=cr.settings.api_base+f.name+g;this.xhr=new XMLHttpRequest();if(j==="GET"&&i){this.xhr.open(j,h+((/\?/).test(h)?"&":"?")+(new Date()).getTime(),true)}else{this.xhr.open(j,h,true)}this.xhr.setRequestHeader("X-Requested-With","XMLHttpRequest");this.xhr.withCredentials=true;this.xhr.onprogress=(function(k){if(this.onloadprogress){this.onloadprogress(k)}}).bind(this);this.xhr.upload.onprogress=(function(k){if(this.onuploadprogress){this.onuploadprogress(k)}}).bind(this);this.xhr.onreadystatechange=(function(){if(this.xhr.readyState===4){var m;if(this.xhr.status===200){try{var l=JSON.parse(this.xhr.responseText);this.success=l.errno===0;this.data=l;m=new cr.Event((l.errno===0)?"load":"error",false,true);m.recObj=l}catch(k){this.success=false;this.data={errno:2,error:"Error receiving data"};m=new cr.Event("error",false,true);m.recObj={errno:2,error:"Error receiving data"}}}else{this.success=false;this.data={errno:this.xhr.status,error:this.xhr.statusText};m=new cr.Event("error",false,true);m.recObj={errno:this.xhr.status,error:this.xhr.statusText}}this.dispatchEvent(m)}}).bind(this)}extend(e,cr.EventTarget);e.prototype.extend({onload:null,onerror:null,onuploadprogress:null,onloadprogress:null,send:function(){this.xhr.send()},sendRaw:function(f){this.xhr.send(f)},sendForm:function(f){this.xhr.setRequestHeader("Content-Type","application/x-www-form-urlencoded");this.xhr.send(f)},sendJSON:function(f){this.xhr.setRequestHeader("Content-Type","application/json");this.xhr.send(JSON.stringify(f))}});a.prototype={update:function(g,h){if(!this._cache[g.id]){this._cache[g.id]={data:{}}}for(var f in g){if(this.fields.indexOf(f)!==-1){this._cache[g.id].data[f]=g[f]}}this._cache[g.id].dirty=h},get:function(h,g){if(this._cache[h]&&this._cache[h].dirty>0){if(g){g(deepCopy(this._cache[h].data))}}else{var f=new e(this,"GET","/"+h+"/",this._cache[h]);f.onload=(function(i){this.update(i.recObj,1);if(g){g(deepCopy(this._cache[h].data))}}).bind(this);f.onerror=function(i){cr.errorHandler(i)};f.send()}},put:function(j,g,i,h){var f=new e(this,"PUT","/"+j+"/");f.onload=(function(k){if(i){this.update(k.recObj,2)}if(h){h(deepCopy(this._cache[j].data))}}).bind(this);f.onerror=function(k){cr.errorHandler(k)};f.sendJSON(g)},post:function(g,h){var f=new e(this,"POST","/");f.onload=(function(i){this.update(i.recObj,2);if(h){h(deepCopy(this._cache[i.recObj.id].data))}}).bind(this);f.onerror=function(i){cr.errorHandler(i)};f.sendJSON(g)},remove:function(h,g){var f=new e(this,"DELETE","/"+h+"/");f.onload=(function(i){if(this._cache[i.recObj.id]){delete this._cache[i.recObj.id]}if(g){g(i.recObj)}}).bind(this);f.onerror=function(i){cr.errorHandler(i)};f.send()},setup:function(f){if(f){d(this)}}};function d(f){b.push(f)}function c(){var f=6*60*1000;var g=function(){var h=new e({name:"dirty"},"GET","/",true);h.onerror=function(i){if(i.recObj.errno!==403){setTimeout(g,f)}};h.onload=function(o){for(var m=0;m<b.length;m++){var l=b[m],n=o.recObj[l.name];for(var k=0;n&&k<n.length;k++){l._cache[n[m]]&&(l._cache[n[m]].dirty--)}}setTimeout(g,f)};h.send()};setTimeout(g,f)}return{BaseModel:a,APIRequest:e,ModelInit:c}});cr.ModelInit();cr.define("cr",function(){function c(d,e){Object.defineProperty(this,"model",{value:d});Object.defineProperty(this,"has_prev",{get:function(){return this._cache[this.pos].meta.previous.length>0}});Object.defineProperty(this,"has_next",{get:function(){return this._cache[this.pos].meta.next.length>0}});Object.defineProperty(this,"page",{get:function(){return this._cache[this.pos].meta.page}});Object.defineProperty(this,"total",{get:function(){return this._cache[this.pos].meta.total}});Object.defineProperty(this,"obj_list",{get:function(){return this._cache[this.pos].objects}});this._cache={};this.pos=0;(a.bind(this))(e,0)}function b(f,h){var g=[],d=0;for(var e=0;e<f.objects.length;e++){this.model.get(f.objects[e],(function(j,i){g[j]=i;d++;if(d===f.objects.length){if(h){h.call(this,g)}}}).bind(this,e))}}function a(e,g,f){if(this._cache[g]){if(this._cache[g].state===1){(b.bind(this))(this._cache[g],f)}else{this._cache[g].callback=f}}else{if(!e){return}this._cache[g]={state:0,callback:f,objects:[],meta:{}};var d=new cr.APIRequest(this.model,"GET",e);d.onload=(function(k){var j=this._cache[g],l=k.recObj;j.meta=deepCopy(l.meta);for(var h=0;h<l.objects.length;h++){this.model.update(l.objects[h],1);j.objects.push(l.objects[h].id)}j.state=1;if(j.callback){j.callback.call(this,l.objects)}}).bind(this);d.onerror=cr.errorHandler;d.send()}}c.prototype={load:function(d){(a.bind(this))(null,this.pos,function(){if(d){d.apply(this,arguments)}if(!this._cache[this.pos+1]){(a.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}if(!this._cache[this.pos-1]){(a.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})},next:function(d){if(this._cache[this.pos].meta.next){this.pos++}(a.bind(this))(null,this.pos,function(){if(d){d.apply(this,arguments)}if(!this._cache[this.pos+1]){(a.bind(this))(this._cache[this.pos].meta.next,this.pos+1,null)}})},prev:function(d){if(this._cache[this.pos].meta.previous){this.pos--}(a.bind(this))(null,this.pos,function(){if(d){d.apply(this,arguments)}if(!this._cache[this.pos-1]){(a.bind(this))(this._cache[this.pos].meta.previous,this.pos-1,null)}})}};return{Pager:c}});cr.define("routerManager",function(){function c(){var i=location.hash.substr(1);if(i.charAt(0)=="!"){i=i.substr(1)}return i}function f(k){var n={};var l=k.split("&");for(var j=0;j<l.length;j++){var m=l[j].split("=");n[m[0]]=decodeURIComponent(m[1])}return n}function e(){var o=c(),n;var m=o.indexOf("?");if(m===-1){n={}}else{n=o.slice(m+1,o.length);n=f(n);o=o.slice(0,m)}if(o.length===0){this.pushState(this.defaultRouter.url,true);this.defaultRouter.callback.apply(this.defaultRouter,k);return}if(o[o.length-1]!=="/"){o=o+"/"}for(var l=0;l<this.routers.length;l++){var j=this.routers[l];if(j.re.test(o)){var k;o.replace(j.re,function(){var p=Array.prototype.indexOf.call(arguments,0);k=Array.prototype.slice.call(arguments,1,p);for(var q=0;q<k.length;q++){k[q]=a(k[q])}});k.push(n);j.callback.apply(j,k);return}}cr.notFoundHandler(o)}function b(){window.addEventListener("authload",(function(){window.onpopstate=e.bind(this);this.parseHash()}).bind(this));this.routers=[];this.notFoundHandler=function(){};this.defaultRouter={url:"",callback:function(){},re:new RegExp("")}}function d(i){return i.replace("!","!0").replace("/","!1")}function a(i){return i.replace("!1","/").replace("!0","!")}function h(j,k,m){if(j===c()){return}var i=!k?window.history.pushState:window.history.replaceState,l=this.prefix==0?"#":"#!";i.call(window.history,{},"",l+j);if(!m){this.parseHash()}}function g(k,j,l){assert(k instanceof RegExp,"Regular Expression wanted");var i={url:k.source.replace("\\/","/"),callback:l,re:new RegExp("^"+k.source+"$")};this.routers.push(i);if(j===true){this.defaultRouter=i}}return{globalInitialization:b,encodeComponent:d,decodeComponent:a,pushState:h,register:g,parseHash:e,prefix:0}});routerManager.globalInitialization();cr.define("cr.ui",function(){function b(l,j){var k;if(typeof l=="string"){k=cr.doc.querySelectorAll(l)}else{k=[l]}for(var g=0,h;h=k[g];g++){if(!(h instanceof j)){j.decorate(h)}}}function a(g,h){var i;if(h&&h.ownerDocument){i=h.ownerDocument}else{i=cr.doc}return i.createElement(g)}function f(h){var g,i;if(typeof h=="function"){g=h;i=""}else{g=a;i=h}function j(l){var m=g(i,l);j.decorate(m);for(var k in l){m[k]=l[k]}return m}j.decorate=function(k){k.__proto__=j.prototype;k.decorate()};return j}function e(g,n,m,i){g.style.width="10px";var t=g.ownerDocument;var o=t.defaultView;var q=o.getComputedStyle(g);var l=o.getComputedStyle(n);var s=q.direction=="rtl";var j=g.getBoundingClientRect();var u=n.getBoundingClientRect();var p=s?u.right-j.right:j.left-u.left;var v=parseInt(q.borderLeftWidth,10)+parseInt(q.paddingLeft,10)+parseInt(q.paddingRight,10)+parseInt(q.borderRightWidth,10);var h=s?parseInt(l.paddingLeft,10):parseInt(l.paddingRight,10);var r=n.clientWidth-p-v-h;if(i){r*=i}function k(){if(g.scrollWidth>r){g.style.width=r+"px"}else{g.style.width=0;var w=g.scrollWidth;if(w<m){g.style.width=m+"px"}else{g.style.width=w+"px"}}}g.addEventListener("input",k);k()}function d(g){if(!window.isFinite(g)){console.error("Pixel value is not a number: "+g)}return Math.round(g)+"px"}function c(k){var j=k.target.ownerDocument;var g=Math.min(1,k.detail);function i(l){l.stopPropagation();l.preventDefault()}function h(l){if(l.detail>g){g=l.detail;i(l)}else{j.removeEventListener("dblclick",i,true);j.removeEventListener("click",h,true)}}setTimeout(function(){j.addEventListener("click",h,true);j.addEventListener("dblclick",i,true)},0)}return{decorate:b,define:f,limitInputWidth:e,toCssPx:d,swallowDoubleClick:c}});(function(){if("ontouchstart" in document.documentElement){document.addEventListener("touchstart",function(n){var j=document.body.querySelectorAll(".hover");for(var k=0;k<j.length;k++){j[k].classList.remove("hover")}findAncestor(n.target,function(e){if(e.classList){e.classList.add("hover")}return !e.classList})},true);try{var g=/:hover/;for(var d=0;d<document.styleSheets.length;d++){var h=document.styleSheets[d];for(var c=0;h.cssRules&&c<h.cssRules.length;c++){var l=h.cssRules[c];if(l.type===CSSRule.STYLE_RULE&&g.test(l.selectorText)){var m=l.selectorText.split(","),a=[];for(var b=0;b<m.length;b++){if(!g.test(m[b])){a.push(m[b])}}if(a.length===0){h.deleteRule(c)}else{l.selectorText=a.join(",")}}}}}catch(f){}}})();(function(){var a=window.requestAnimationFrame||window.mozRequestAnimationFrame||window.webkitRequestAnimationFrame||window.msRequestAnimationFrame||function(b){setTimeout(function(){b(Date.now())},30)};window.requestAnimationFrame=a})();cr.define("cr.ui",function(){var a=null;function b(k,h,e){var c=$("notification");var d=c.querySelector(".link-color");var f=e||5000;function j(){window.clearTimeout(a);c.classList.add("show");document.body.classList.add("notification-shown")}function i(){window.clearTimeout(a);c.classList.remove("show");document.body.classList.remove("notification-shown");d.tabIndex=-1;d.blur()}function g(){a=window.setTimeout(i,f)}c.firstElementChild.textContent=k;d.textContent=h;d.onclick=i;d.onkeydown=function(l){if(l.keyIdentifier=="Enter"){i()}};c.onmouseover=j;c.onmouseout=g;d.onfocus=j;d.onblur=g;d.tabIndex=0;j();g()}return{showNotification:b}});cr.define("cr.ui.bbcode",function(){function a(){cr.ui.template.registerBBCode(/\[inlinedisk\](\d+)\[\/inlinedisk\]/ig,'<a class="richtext-inline-disk" href="#!library/$1/" remote_id="$1">...</a>');cr.ui.template.registerBBCode(/\[disk\](\d+)\[\/disk\]/ig,'<div class="richtext-disk" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[rfs\](\d+)\[\/rfs\]/ig,'<div class="richtext-rfs" remote_id="$1"></div>');cr.ui.template.registerBBCode(/\[ticket\](\d+)\[\/ticket\]/ig,'<div class="richtext-ticket" remote_id="$1"></div>');cr.ui.template.register("richtext_disk.html",function(d){var c=this.querySelector(".richtext-disk-cover");if(d.disk.cover_url){c.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+d.disk.cover_url.url+")"}else{c.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.addEventListener("click",(function(e){routerManager.pushState("library/"+e+"/",false,false)}).bind(null,d.disk.id))});cr.ui.template.register("richtext_rfs.html",function(g){var c=this.querySelectorAll(".richtext-rfs-item");for(var d=0;d<c.length;d++){var e=c[d],f=g.rfs["film_"+e.getAttribute("refer")];if(f.cover_url){e.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+f.cover_url.url+")"}else{e.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}e.addEventListener("click",(function(h){routerManager.pushState("library/"+h+"/",false,false)}).bind(null,f.id))}});cr.ui.template.register("richtext_ticket.html",function(d){var c=this.querySelector(".richtext-disk-cover");if(d.ticket.cover_url){c.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+d.ticket.cover_url.url+")"}else{c.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.addEventListener("click",function(){routerManager.pushState("ticket/",false,false)})})}function b(h){var j=h.querySelectorAll(".richtext-inline-disk"),c=h.querySelectorAll(".richtext-disk"),e=h.querySelectorAll(".richtext-rfs"),d=h.querySelectorAll(".richtext-ticket");for(var f=0;f<j.length;f++){var g=j[f],k=g.getAttribute("remote_id");cr.model.Disk.get(k,(function(i){this.textContent=i.title_en+" / "+i.title_ch}).bind(g));g.addEventListener("click",function(i){i.preventDefault();i.stopImmediatePropagation();routerManager.pushState(this.getAttribute("href").substr(2),false,false)})}for(var f=0;f<c.length;f++){var g=c[f],k=g.getAttribute("remote_id");cr.model.Disk.get(k,(function(i){var l=cr.ui.template.render_template("richtext_disk.html",{disk:i});this.appendChild(l);l.classList.remove("loading")}).bind(g))}for(var f=0;f<e.length;f++){var g=e[f],k=g.getAttribute("remote_id");cr.model.RegularFilmShow.get(k,(function(i){var l=cr.ui.template.render_template("richtext_rfs.html",{rfs:i});this.appendChild(l);l.classList.remove("loading")}).bind(g))}for(var f=0;f<d.length;f++){var g=d[f],k=g.getAttribute("remote_id");cr.model.PreviewShowTicket.get(k,(function(l){var i=cr.ui.template.render_template("richtext_ticket.html",{ticket:l});this.appendChild(i);i.classList.remove("loading")}).bind(g))}}return{globalInitialization:a,handleHTML:b}});cr.ui.bbcode.globalInitialization();cr.define("cr.model",function(){var i=new cr.BaseModel("file"),j=new cr.BaseModel("user"),d=new cr.BaseModel("disk"),f=new cr.BaseModel("regularfilmshow"),l=new cr.BaseModel("previewshowticket"),m=new cr.BaseModel("diskreview"),a=new cr.BaseModel("news"),e=new cr.BaseModel("document"),b=new cr.BaseModel("publication"),c=new cr.BaseModel("sponsor"),k=new cr.BaseModel("exco"),h=new cr.BaseModel("sitesettings"),g=new cr.BaseModel("onesentence");i.fields=["id","name","url"];j.fields=["id","expire_at","admin","full_name","itsc","member_type","pennalized","rfs_count","login_count"];d.fields=["id","director_en","director_ch","category","create_log","imdb_url","show_year","avail_type","actors","desc_en","tags","title_en","cover_url","disk_type","due_at","borrow_cnt","length","desc_ch","title_ch","user_held"];d.CN=function(n){return n.disk_type+pad(n.id,4)};f.fields=["id","state","film_1","film_2","film_3","vote_cnt_1","vote_cnt_2","vote_cnt_3","remarks","create_log"];l.fields=["id","state","title_en","title_ch","desc_en","desc_ch","director_en","director_ch","actors","cover_url","language","subtitle","venue","show_time","apply_deadline","length","quantity","remarks","successful_applicant","create_log"];m.fields=["id","disk","content","create_log"];a.fields=["id","title","content","create_log"];e.fields=["id","title","doc_url","create_log"];b.fields=["id","Type","title","cover_url","doc_url","ext_doc_url","create_log"];c.fields=["id","name","img_url"];k.fields=["id","name_en","name_ch","descript","position","email","img_url"];h.fields=["id","key","value"];h._cache_dict={};h.loadSettings=function(o){var n=new cr.APIRequest(this,"GET","/",true);n.onload=function(q){for(var p=0;p<q.recObj.objects.length;p++){h.update(q.recObj.objects[p],1);h._cache_dict[q.recObj.objects[p].key]=q.recObj.objects[p].id}if(o){o()}};n.onerror=cr.errorHandler;n.send()};h.getField=function(n){if(!this._cache_dict[n]){return null}return this._cache[this._cache_dict[n]].data};g.fields=["id","content","film"];return{File:i,User:j,Disk:d,RegularFilmShow:f,PreviewShowTicket:l,DiskReview:m,News:a,Document:e,Publication:b,Sponsor:c,Exco:k,SiteSettings:h,OneSentence:g}});cr.model.Disk.setup(true);cr.model.RegularFilmShow.setup(true);cr.model.PreviewShowTicket.setup(true);cr.model.News.setup(true);cr.model.Document.setup(true);cr.model.Publication.setup(true);cr.model.Sponsor.setup(true);cr.model.Exco.setup(true);cr.define("cr.ui",function(){function a(e,f){var d=$("content-wrapper");d.classList.add("loading");if(e instanceof HTMLElement||e instanceof DocumentFragment){setTimeout(function(){d.setAttribute("hidden",true);while(d.firstChild){d.removeChild(d.firstChild)}d.appendChild(e);d.removeAttribute("hidden");setTimeout(function(){d.classList.remove("loading")},0);if(f){f()}},cr.view.name?210:0)}else{if(e instanceof Function){setTimeout(function(){d.setAttribute("hidden",true);while(d.firstChild){d.removeChild(d.firstChild)}e(d);d.removeAttribute("hidden");setTimeout(function(){d.classList.remove("loading")},0);if(f){f()}},cr.view.name?210:0)}else{d.classList.remove("loading");assert(false,"Error processing content")}}}function c(e){var d=document.querySelector('#footer a[controls="'+e+'"]');b(d)}function b(d){var e=document.querySelector("#footer a.selected");if(e!==d){d.classList.add("selected");if(e){e.classList.remove("selected")}}}return{replaceContent:a,changeSelection:c,setSelection:b}});cr.define("cr.ui.select",function(){function a(b){b.value="";b.name=b.getAttribute("name");b.type="select";b.querySelector(".custom-options").addEventListener("click",function(c){if(c.target===this){return}b.querySelector(".default").textContent=c.target.textContent;b.value=c.target.getAttribute("value");this.setAttribute("hidden",true);setTimeout((function(){this.removeAttribute("hidden")}).bind(this),0)})}return{init:a}});cr.define("OneSentence",function(){function a(){var b=new cr.APIRequest(cr.model.OneSentence,"GET","/rand/",true);b.onload=function(d){var c=$("onesentence");c.querySelector("span").textContent=d.recObj.content;c.setAttribute("tooltip","From: "+cr.ui.template.escapeAttr(d.recObj.film))};b.onerror=function(c){};b.send()}return{Initialization:a}});document.addEventListener("DOMContentLoaded",OneSentence.Initialization);cr.define("Application",function(){var b={Full:"Full Member",OneSem:"One Semester Member",OneYear:"One Year Member",TwoYear:"Two Year Member",ThreeYear:"Three Year Member",Honour:"Honour Member",Assoc:"Asscocitate Member"};function d(){window.addEventListener("moduleload",function(){var f=new cr.APIRequest(cr.model.User,"GET","/current_user/",true);f.onload=function(g){cr.define("cr",function(){return{user:deepCopy(g.recObj)}});var h=cr.ui.template.render_template("user_panel.html",{user:g.recObj,table:b});h.querySelector(".link-logout").addEventListener("click",function(){var j=location.hash.substr(1),i=cr.settings.logout_url+(j?"?next="+j:"");location.href=i});h.querySelector(".link-admin").addEventListener("click",function(){window.open("admin/")});$("header").replaceChild(h,$("user-wrapper"));cr.ui.showNotification(g.recObj.full_name+", Welcome back!","dismiss");cr.model.SiteSettings.loadSettings(function(){cr.dispatchSimpleEvent(window,"authload",false,false)})};f.onerror=function(g){if(g.recObj.errno===2){$("user-wrapper").querySelector(".link-login").addEventListener("click",function(){var i=location.hash.substr(1),h=cr.settings.login_url+(i?"?next="+i:""),j="https://cas.ust.hk/cas/login?service="+encodeURIComponent(h);location.href=j});cr.model.SiteSettings.loadSettings(function(){cr.dispatchSimpleEvent(window,"authload",false,false)})}else{a(g)}};f.send()});window.addEventListener("authload",cr.ui.hideLoading);cr.define("cr",function(){return{errorHandler:a,notFoundHandler:e}});$("footer").addEventListener("click",function(g){var f=g.target.getAttribute("href").substr(2);routerManager.pushState(f,false,false);g.preventDefault();g.stopPropagation()},true);routerManager.prefix=1}function a(h){var g=h.recObj.errno,f=h.recObj.error||"Connection Failed";switch(g){case 0:case 1:case 2:case 3:cr.ui.showNotification(f,"dismiss");break;case 404:e();break;default:cr.ui.showNotification("Server: "+f,"try again later")}}function e(){var f=cr.ui.template.render_template("error_page.html",{text:"Oops... 404 Page Not Found."});cr.view.name="404";document.title="404 Page Not Found | Film Society, HKUSTSU";cr.ui.replaceContent(f)}function c(h){var f=h.querySelectorAll("input:enabled, select:enabled, textarea:enabled, .input"),j={};for(var g=0;g<f.length;g++){j[f[g].name]=(f[g].type==="checkbox")?f[g].checked:f[g].value;if(j[f[g].name]==undefined||j[f[g].name]===""){j[f[g].name]=null;if(f[g].getAttribute("role")==="list"){j[f[g].name]=""}}}return j}return{initialization:d,collectForm:c}});document.addEventListener("DOMContentLoaded",Application.initialization);cr.ui.template.register("user_panel.html");cr.ui.template.register("error_page.html");cr.define("cr.view.library",function(){var a="library";function j(){routerManager.register(/library\//,false,c(b));routerManager.register(/library\/search\//,false,c(g));routerManager.register(/library\/(\d+)\//,false,c(h));routerManager.register(/library\/rand\//,false,c(f));cr.ui.template.register("liba_template.html",function(){var k=this;i(k);this.querySelector('button[controls="search"]').addEventListener("click",function(){var l=k.querySelector('input[name="search_term"]').value;if(l){routerManager.pushState("library/search/?q="+encodeURIComponent(l),false,true);e(k,g,[{q:l}])}});this.querySelector('button[controls="random"]').addEventListener("click",function(){routerManager.pushState("library/rand/",false,true);e(k,f)});this.querySelector('button[controls="popular"]').addEventListener("click",function(){routerManager.pushState("library/?mode=popular",false,true);e(k,b,[{mode:"popular"}])});this.querySelector('button[controls="rank"]').addEventListener("click",function(){routerManager.pushState("library/?mode=rank",false,true);e(k,b,[{mode:"rank"}])})});cr.ui.template.register("liba_suggest_item.html",function(l){var k=this.querySelector(".item-cover");if(l.disk.cover_url){k.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+l.disk.cover_url.url+")"}else{k.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("liba_list.html");cr.ui.template.register("liba_list_notfound.html",function(){this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("library/",false,true);e(document.querySelector(".library-wrapper"),b,[{}])}})});cr.ui.template.register("liba_list_item.html",function(m){var l=this.querySelector("div.disk-cover-border"),k=this.querySelector(".disk-detail-button");if(m.disk.cover_url){l.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+m.disk.cover_url.url+")"}else{l.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}k.addEventListener("click",(function(n){routerManager.pushState("library/"+n+"/",false,true);e(document.querySelector(".library-wrapper"),h,[n])}).bind(null,m.disk.id))});cr.ui.template.register("liba_disk.html",function(){var k=this.querySelector(".popup-overlay");k.addEventListener("close",function(){this.classList.add("loading");setTimeout((function(){this.setAttribute("hidden",true)}).bind(this),210)});k.addEventListener("click",function(l){l.target===this&&cr.dispatchSimpleEvent(this,"close",true,true)});k.addEventListener("keydown",function(l){if(l.keyCode===27){cr.dispatchSimpleEvent(this,"close",true,true)}});k.querySelector(".close-button").addEventListener("click",function(){cr.dispatchSimpleEvent(k,"close",true,true)})});cr.ui.template.register("liba_disk_detail.html",function(r){var p=this.querySelector(".disk-brief .disk-cover");if(r.disk.cover_url){p.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+r.disk.cover_url.url+")"}else{p.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("library/",false,true);e(document.querySelector(".library-wrapper"),b,[{}])}});var n=this.querySelector(".actors-wrapper");for(var m=0;m<r.disk.actors.length;m++){var l=createElementWithClassName("span","link link-search");l.setAttribute("tag","actor");l.textContent=r.disk.actors[m];(m>0)&&n.appendChild(createElementWithClassName("span","space"));n.appendChild(l)}var o=this.querySelector(".tags-wrapper");for(var m=0;m<r.disk.tags.length;m++){var k=createElementWithClassName("span","link link-search");k.setAttribute("tag","tag");k.textContent=r.disk.tags[m];(m>0)&&o.appendChild(createElementWithClassName("span","space"));o.appendChild(k)}var q=this.querySelectorAll(".link-search");for(var m=0;m<q.length;m++){q[m].addEventListener("click",function(u){var s=this.getAttribute("tag"),t=s+":("+this.textContent+")";routerManager.pushState("library/search/?q="+encodeURIComponent(t),false,true);e(document.querySelector(".library-wrapper"),g,[{q:t}])})}this.querySelector('button[controls="reserve"]').addEventListener("click",function(){var s=document.querySelector(".library-wrapper .library-disk .popup-overlay"),v=s.querySelector(".popup-box"),u=v.querySelector(".content"),t=cr.ui.template.render_template("liba_disk_reserve.html",{disk:r.disk});v.querySelector("h1").textContent="Reserve Disk";while(u.firstChild){u.removeChild(u.firstChild)}u.appendChild(t);v.classList.remove("loading");s.removeAttribute("hidden");setTimeout(function(){s.classList.remove("loading")},0)});this.querySelector('button[controls="renew"]').addEventListener("click",function(){var s=document.querySelector(".library-wrapper .library-disk .popup-overlay"),v=s.querySelector(".popup-box"),u=v.querySelector(".content"),t=cr.ui.template.render_template("liba_disk_renew.html",{disk:r.disk});v.querySelector("h1").textContent="Renew Disk";while(u.firstChild){u.removeChild(u.firstChild)}u.appendChild(t);v.classList.remove("loading");s.removeAttribute("hidden");setTimeout(function(){s.classList.remove("loading")},0)})});cr.ui.template.register("liba_disk_reserve.html",function(n){var m=this,l=this.querySelectorAll(".custom-select");for(var k=0;k<l.length;k++){cr.ui.select.init(l[k])}this.querySelector('button[controls="deliver"]').addEventListener("click",function(){var p=Application.collectForm(m.querySelector(".reserve-delivery")),o=new cr.APIRequest(cr.model.Disk,"POST","/"+n.disk.id+"/reservation/");p.form="Hall";p.hall=~~(p.hall);o.onload=function(r){var q=r.recObj;cr.model.Disk.update(q,1);cr.ui.showNotification("Disk reserved","dismiss");history.go()};o.onerror=function(q){m.classList.remove("loading");cr.errorHandler(q)};m.classList.add("loading");o.sendJSON(p)});this.querySelector('button[controls="reserve"]').addEventListener("click",function(){var o=new cr.APIRequest(cr.model.Disk,"POST","/"+n.disk.id+"/reservation/"),p={form:"Counter"};o.onload=function(r){var q=r.recObj;cr.model.Disk.update(q,2);cr.ui.showNotification("Disk reserved","dismiss");history.go()};o.onerror=function(q){m.classList.remove("loading");cr.errorHandler(q)};m.classList.add("loading");o.sendJSON(p)})});cr.ui.template.register("liba_disk_renew.html",function(l){var k=this;this.querySelector('button[controls="renew"]').addEventListener("click",function(){var m=new cr.APIRequest(cr.model.Disk,"POST","/"+l.disk.id+"/borrow/"),n={id:cr.user&&cr.user.id};m.onload=function(p){var o=p.recObj;cr.model.Disk.update(o,2);cr.ui.showNotification("Disk renewed","dismiss");history.go()};m.onerror=function(o){k.classList.remove("loading");cr.errorHandler(o)};k.classList.add("loading");m.sendJSON(n)})});cr.ui.template.register("disk_review_entry.html")}function c(k){return function(){if(cr.model.SiteSettings.getField("liba_state").value!=="Open"){var l=cr.ui.template.render_template("error_page.html",{text:"Sorry, The VCD/DVD Library is temporarily closed."});cr.ui.replaceContent(l,function(){cr.ui.changeSelection(a);cr.view.name=a});return}if(cr.view.name!==a){var m=cr.ui.template.render_template("liba_template.html");cr.ui.replaceContent(m,(function(n){cr.ui.changeSelection(a);cr.view.name=a;k.apply(this,n)}).bind(m,arguments))}else{e(document.querySelector(".library-wrapper"),k,arguments)}}}function e(l,m,n){var k=l.querySelector(".right-panel");k.classList.add("loading");setTimeout(function(){k.setAttribute("hidden",true);while(k.firstChild){k.removeChild(k.firstChild)}m.apply(l,n)},210)}function d(o,l,n){var r=0,m=o.querySelector(".list-item-wrapper");l.load(q);o.querySelector(".prev-button").addEventListener("click",function(){r--;routerManager.pushState(n(r),false,true);o.classList.add("loading");l.prev(k)});o.querySelector(".next-button").addEventListener("click",function(){r++;routerManager.pushState(n(r),false,true);o.classList.add("loading");l.next(q)});function k(s){p.call(this,s,"prev")}function q(s){p.call(this,s,"next")}function p(u,x){var w=m.querySelectorAll(".list-item"),s=m.querySelectorAll(".library-notfound");for(var t=0;t<w.length;t++){w[t].classList.add(x=="next"?"at_left":"at_right")}for(var t=0;t<s.length;t++){s[t].classList.add("loading")}if(u.length===0){var y=cr.ui.template.render_template("liba_list_notfound.html");m.appendChild(y);o.querySelector(".prev-button").setAttribute("hidden",true);o.querySelector(".next-button").setAttribute("hidden",true);setTimeout(function(){y.classList.remove("loading")},0)}else{if(this.has_prev){o.querySelector(".prev-button").removeAttribute("hidden")}else{o.querySelector(".prev-button").setAttribute("hidden",true)}if(this.has_next){o.querySelector(".next-button").removeAttribute("hidden")}else{o.querySelector(".next-button").setAttribute("hidden",true)}for(var t=0;t<u.length;t++){var v=cr.ui.template.render_template("liba_list_item.html",{disk:u[t]});v.classList.add(x=="next"?"at_right":"at_left");v.classList.add("item-"+t);m.appendChild(v);setTimeout((function(){this.classList.remove(x=="next"?"at_right":"at_left")}).bind(v),0)}}o.classList.remove("loading");setTimeout(function(){for(var z=0;z<w.length;z++){m.removeChild(w[z])}for(var z=0;z<s.length;z++){m.removeChild(s[z])}},410)}}function b(r){var q=r.mode||"",o=r.page||1,p=cr.ui.template.render_template("liba_list.html"),l=this.querySelector(".right-panel"),k=new cr.Pager(cr.model.Disk,m(q,o));l.appendChild(p);l.removeAttribute("hidden");l.classList.remove("loading");switch(q){case"popular":document.title="Top Popular | Film Society, HKUSTSU";break;case"rank":document.title="Top Ranked | Film Society, HKUSTSU";break;default:document.title="VCD/DVD Library | Film Society, HKUSTSU"}var n=function(v){var t=[],s=~~(o)+~~(v),u="library/";if(s!==1){t.push("page="+encodeURIComponent(s))}switch(q){case"popular":case"rank":t.push("mode="+encodeURIComponent(q))}return u+((t.length!==0)?("?"+t.join("&")):"")};d(p,k,n);function m(u,t){var s="/?limit=6&page="+encodeURIComponent(t);switch(u){case"popular":s+="&ordering=-borrow_cnt,-id";break;case"rank":s+="&ordering=-rank,-id"}return s}}function g(l){var s=l.q||"",q=l.page||1,n=cr.ui.template.render_template("liba_list.html"),k=this.querySelector(".right-panel"),o=this.querySelector('.left-panel .library-search input[name="search_term"]'),m=new cr.Pager(cr.model.Disk,r(s,q));o.value=s;k.appendChild(n);k.removeAttribute("hidden");k.classList.remove("loading");document.title="Searching For "+s+" | Film Society, HKUSTSU";var p=function(w){var u=[],t=~~(q)+~~(w),v="library/search/";u.push("q="+encodeURIComponent(s));if(t!==1){u.push("page="+encodeURIComponent(t))}return v+((u.length!==0)?("?"+u.join("&")):"")};d(n,m,p);function r(v,u){var t="/search/?limit=6&page="+encodeURIComponent(u);t+="&query="+encodeURIComponent(v);return t}}function i(s){var p=s.querySelector('.left-panel input[name="search_term"]'),t=s.querySelector(".left-panel .search-suggestion"),m=0,w=0,l=[],k=0;p.addEventListener("keypress",function(x){if(x.keyCode>=46||x.keyCode<=9){r(this.value,t)}});p.addEventListener("keyup",function(x){if(x.keyCode>=46||x.keyCode<=9){r(this.value,t)}});p.addEventListener("focus",function(){v(p);r(this.value,t)});p.addEventListener("blur",function(){u(t);q(p)});function o(x){switch(x.keyCode){case 13:if(m!==0){var y=l[m-1];this.value="";this.blur();routerManager.pushState("library/"+y+"/",false,true);e(document.querySelector(".library-wrapper"),h,[y])}else{this.blur();routerManager.pushState("library/search/?q="+encodeURIComponent(this.value),false,true);e(document.querySelector(".library-wrapper"),g,[{q:this.value}])}break;case 27:this.blur();break;case 38:x.preventDefault();m=(m+w)%(w+1);n(m);break;case 40:x.preventDefault();m=(m+w+2)%(w+1);n(m);break}}function v(x){x.addEventListener("keydown",o,true);k=1}function q(x){k=0;x.removeEventListener("keydown",o)}function n(x){var z=t.querySelector(".selected"),y=t.querySelector(".suggest-item:nth-of-type("+x+")");if(z===y){return}z&&z.classList.remove("selected");y&&y.classList.add("selected")}function r(z,y){if(z===""||/[:()]/.test(z)){return u(y)}var x=new cr.APIRequest(cr.model.Disk,"GET","/search/?limit=5&engine=defualt&query="+encodeURIComponent(z));x.onload=function(D){if(p.value!==z||k===0){return}var C=D.recObj.objects;u(y);w=C.length;y.removeAttribute("hidden");for(var A=0;A<C.length;A++){cr.model.Disk.update(C[A],1);var B=cr.ui.template.render_template("liba_suggest_item.html",{disk:C[A]});y.appendChild(B);B.addEventListener("mouseover",(function(E){if(m===E){return}m=E;n(E)}).bind(B,A+1));B.addEventListener("mousedown",(function(E){p.value="";p.blur();routerManager.pushState("library/"+E+"/",false,true);e(document.querySelector(".library-wrapper"),h,[E])}).bind(null,C[A].id));l.push(C[A].id);setTimeout((function(){this.classList.remove("loading")}).bind(B),A*50)}};x.send()}function u(x){x.setAttribute("hidden",true);while(x.firstChild){x.removeChild(x.firstChild)}m=0;w=0;l=[]}}function h(m){var l=cr.ui.template.render_template("liba_disk.html",{user:cr.user}),k=this.querySelector(".right-panel");k.appendChild(l);k.removeAttribute("hidden");k.classList.remove("loading");cr.model.Disk.get(m,function(p){var q=cr.ui.template.render_template("liba_disk_detail.html",{disk:p,cn:cr.model.Disk.CN(p),user:cr.user}),x=l.querySelector(".diskreview-wrapper");l.querySelector(".disk-wrapper").appendChild(q);setTimeout(function(){l.classList.remove("loading")},0);document.title=p.title_en+" "+p.title_ch+" | Film Society, HKUTSU";var n=new cr.APIRequest(cr.model.Disk,"GET","/"+m+"/rate/");n.onload=function(F){var C=F.recObj,B=l.querySelector(".rate-box .rate-num"),E=l.querySelector(".rate-box .rate-up-button"),r=l.querySelector(".rate-box .rate-down-button");B.textContent=C.ups-C.downs;if(C.ups>C.downs){B.classList.add("positive")}else{if(C.ups<C.downs){B.classList.add("negative")}}if(C.rated){E.setAttribute("tooltip","You have rated before");r.setAttribute("tooltip","You have rated before")}else{E.addEventListener("click",function(){D("up")});r.addEventListener("click",function(){D("down")})}l.querySelector(".rate-box").classList.remove("loading");function D(H){var G=new cr.APIRequest(cr.model.Disk,"POST","/"+m+"/rate/");G.onload=function(J){var I=J.recObj;if(!B){return}B.textContent=I.ups-I.downs;if(I.ups>I.downs){B.classList.add("positive")}else{if(I.ups<I.downs){B.classList.add("negative")}}if(I.rated){E.setAttribute("tooltip","You have rated before");r.setAttribute("tooltip","You have rated before")}cr.ui.showNotification("Rate successful","dismiss")};G.onerror=function(){cr.ui.showNotification("Rate failed","dismiss")};G.sendJSON({rate:H})}};n.send();var s=new cr.Pager(cr.model.DiskReview,"/?disk="+m),A=true,o=true,w=false,z=l.querySelector(".diskreview-wrapper"),t=z.querySelector(".diskreview-inner-wrapper"),u=t.querySelector(".anchor");s.load(v);function v(C){if(A){A=false;if(C.length===0){w=true;if(w){u.textContent="Be the first one to comment"}}var B=z.querySelector('.diskreview-input-box button[controls="submit"]');B.addEventListener("click",function(){var E=z.querySelector('.diskreview-input-box textarea[name="review"]');if(!E.value){return}var F={disk:m,content:E.value};cr.model.DiskReview.post(F,function(H){var I=t.querySelector(".diskreview-title").nextSibling,G=cr.ui.template.render_template("disk_review_entry.html",{review:H});t.insertBefore(G,I);if(w){t.removeChild(u);w=false}setTimeout(function(){G.classList.remove("loading")},0)})})}for(var r=0;r<C.length;r++){var D=cr.ui.template.render_template("disk_review_entry.html",{review:C[r]});t.insertBefore(D,u);setTimeout((function(){this.classList.remove("loading")}).bind(D),50*r)}if(!this.has_next&&!w){t.removeChild(u);z.querySelector(".diskreview-entry-wrapper").removeEventListener("scroll",y)}o=false}function y(C){if(o){return}C.preventDefault();C.stopImmediatePropagation();var B=z.scrollTop,D=z.clientHeight,r=z.scrollHeight;if(B+D+5>r){o=true;pager.next(v)}}})}function f(){var l=new cr.APIRequest(cr.model.Disk,"GET","/rand/",true),k=this;l.onload=function(m){cr.model.Disk.update(m.recObj,1);h.call(k,m.recObj.id)};l.onerror=cr.errorHandler;l.send()}return{Initialization:j}});cr.view.library.Initialization();cr.define("cr.view.show",function(){var c="show";function a(g){if(g.film_1.avail_type==="Onshow"){return g.film_1}if(g.film_2.avail_type==="Onshow"){return g.film_2}if(g.film_3.avail_type==="Onshow"){return g.film_3}return null}function f(){routerManager.register(/show\//,false,d(e));cr.ui.template.register("rfs_template.html");cr.ui.template.register("rfs_true_template.html",function(j){var l=this.querySelectorAll(".rfs-film-strip"),n=this.querySelector(".info-tab");for(var m=0;m<l.length;m++){var o=l[m].getAttribute("refer"),p=l[m].querySelector(".rfs-cover"),g=j.show["film_"+o];if(g.cover_url){p.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+g.cover_url.url+")"}else{p.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}var k=this.querySelector('.info-tab .rfs-film-info[refer="'+o+'"] .actors-wrapper');k.textContent=g.actors.join(", ");var h=this.querySelector('.info-tab .rfs-film-info[refer="'+o+'"] .tags-wrapper');h.textContent=g.tags.join(", ");l[m].querySelector(".rfs-cover").addEventListener("click",(function(q,i){routerManager.pushState("library/"+q+"/",false);i.preventDefault();i.stopPropagation();i.stopImmediatePropagation()}).bind(null,g.id),true);l[m].querySelector('button[controls="vote"]').addEventListener("click",b.bind(null,j.show.id,o));l[m].addEventListener("mouseover",(function(q){var r=this.querySelectorAll("div[selected]");for(var s=0;s<r.length;s++){r[s].removeAttribute("selected")}this.querySelector('.rfs-film-info[refer="'+q+'"]').setAttribute("selected",true)}).bind(n,o));l[m].addEventListener("mouseout",(function(){var q=this.querySelectorAll("div[selected]");for(var r=0;r<q.length;r++){q[r].removeAttribute("selected")}this.querySelector(".rfs-remarks").setAttribute("selected",true)}).bind(n))}})}function b(i,g){var h=new cr.APIRequest(cr.model.RegularFilmShow,"POST","/"+i+"/vote/");h.onload=function(j){cr.ui.showNotification("Vote success","dismiss");history.go()};h.onerror=cr.errorHandler;h.sendJSON({film_id:g})}function d(g){return function(){cr.view.name=c;cr.ui.changeSelection(c);document.title="Regular Film Show | Film Society, HKUSTSU";if(cr.model.SiteSettings.getField("rfs_state").value!=="Open"){var i=cr.ui.template.render_template("error_page.html",{text:"Sorry, Regular Film Show is temporarily closed."});cr.ui.replaceContent(i);return}var h=cr.ui.template.render_template("rfs_template.html");cr.ui.replaceContent(h,(function(j){g.apply(this,j)}).bind(h,arguments))}}function e(){var i=this,j=this.querySelector(".rfs-content-wrapper"),h=new cr.Pager(cr.model.RegularFilmShow,"/?limit=1");h.load(g);function g(l){if(l.length===0){var m=cr.ui.template.render_template("error_page.html",{text:"Sorry, No Regular Film Show available."});cr.ui.replaceContent(m);return}var k=cr.ui.template.render_template("rfs_true_template.html",{show:l[0],user:cr.user,toshow:a(l[0])});cr.model.Disk.update(l[0].film_1,1);cr.model.Disk.update(l[0].film_2,1);cr.model.Disk.update(l[0].film_3,1);j.appendChild(k);j.removeAttribute("hidden");setTimeout(function(){i.classList.remove("loading");var n=j.querySelectorAll(".rfs-film-strip .vote-bar"),q=l[0].vote_cnt_1+l[0].vote_cnt_2+l[0].vote_cnt_3;for(var p=0;p<n.length;p++){var o=l[0]["vote_cnt_"+(p+1)];n[p].style.top=(100-90*(o/(q+0.0001)))+"%"}},0)}}return{Initialization:f}});cr.view.show.Initialization();cr.define("cr.view.ticket",function(){var b="ticket";function e(){routerManager.register(/ticket\//,false,d(a));cr.ui.template.register("ticket_template.html",function(){var f=this.querySelector(".popup-overlay");f.addEventListener("close",function(){this.classList.add("loading");setTimeout((function(){this.setAttribute("hidden",true)}).bind(this),210)});f.addEventListener("click",function(g){g.target===this&&cr.dispatchSimpleEvent(this,"close",true,true)});f.addEventListener("keydown",function(g){if(g.keyCode===27){cr.dispatchSimpleEvent(this,"close",true,true)}});f.querySelector(".close-button").addEventListener("click",function(){cr.dispatchSimpleEvent(f,"close",true,true)})});cr.ui.template.register("ticket_list_item.html",function(g){var f=this.querySelector(".item-cover");if(g.ticket.cover_url){f.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+g.ticket.cover_url.url+")"}else{f.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}});cr.ui.template.register("ticket_detail.html",function(g){var f=this.querySelector(".ticket-brief .ticket-cover");if(g.ticket.cover_url){f.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+g.ticket.cover_url.url+")"}else{f.style.backgroundImage="url("+cr.settings.resource_base+"css/question.png)"}this.querySelector('button[controls="apply"]').addEventListener("click",function(){var h=document.querySelector(".ticket-wrapper .popup-overlay"),j=h.querySelector(".popup-box"),i=j.querySelector(".content"),k=cr.ui.template.render_template("ticket_apply.html",{ticket:g.ticket});j.querySelector("h1").textContent="Apply For Ticket";while(i.firstChild){i.removeChild(i.firstChild)}i.appendChild(k);j.classList.remove("loading");h.removeAttribute("hidden");setTimeout(function(){h.classList.remove("loading")},0)})});cr.ui.template.register("ticket_apply.html",function(j){var h=this,g=this.querySelectorAll(".custom-select");for(var f=0;f<g.length;f++){cr.ui.select.init(g[f])}this.querySelector('button[controls="apply"]').addEventListener("click",function(){var k=Application.collectForm(h),i=new cr.APIRequest(cr.model.PreviewShowTicket,"POST","/"+j.ticket.id+"/application/");k.number=~~(k.number);i.onload=function(l){cr.ui.showNotification("Ticket applied","dismiss");cr.dispatchSimpleEvent(h,"close",true,true)};i.onerror=function(l){h.classList.remove("loading");cr.errorHandler(l)};h.classList.add("loading");i.sendJSON(k)})})}function d(f){return function(){if(cr.model.SiteSettings.getField("pst_state").value!=="Open"){var g=cr.ui.template.render_template("error_page.html",{text:"Sorry, The Preview Show Ticket is temporarily closed."});cr.ui.replaceContent(g,function(){cr.ui.changeSelection(b);cr.view.name=b;document.title="Preview Show Ticket | Film Society, HKUSTSU"});return}var h=cr.ui.template.render_template("ticket_template.html");cr.ui.replaceContent(h,(function(i){cr.ui.changeSelection(b);cr.view.name=b;document.title="Preview Show Ticket | Film Society, HKUSTSU";f.apply(this,i)}).bind(h,arguments))}}function c(h,i){var g=h.querySelector(".right-panel"),f=g.querySelector(".ticket-detail-wrapper");g.classList.add("loading");cr.model.PreviewShowTicket.get(i,function(j){setTimeout(function(){document.title=j.title_en+" "+j.title_ch+" | Film Society, HKUSTSU";f.setAttribute("hidden",true);while(f.firstChild){f.removeChild(f.firstChild)}var k=cr.ui.template.render_template("ticket_detail.html",{ticket:j,user:cr.user});f.appendChild(k);f.removeAttribute("hidden");setTimeout(function(){g.classList.remove("loading")},0)},410)})}function a(){var h=this,m=this.querySelector(".left-panel .ticket-list-wrapper"),j=m.querySelector(".anchor"),g=this.querySelector(".right-panel"),i=new cr.Pager(cr.model.PreviewShowTicket,"/?limit=10"),f=true,k=true;m.addEventListener("scroll",l);i.load(o);function o(q){if(q.length===0||!this.has_next){m.removeChild(j);m.removeEventListener("scroll",l)}for(var p=0;p<q.length;p++){var r=cr.ui.template.render_template("ticket_list_item.html",{ticket:q[p]});r.addEventListener("click",(function(s,u,t){c(s,u);n(this)}).bind(r,h,q[p].id));m.appendChild(r);setTimeout((function(){this.classList.remove("loading")}).bind(r),p*100+400);if(k&&p==0){n(r);c(h,q[p].id)}}if(k){if(q.length===0){}k=false}f=false}function l(r){if(f){return}r.preventDefault();r.stopImmediatePropagation();var q=m.scrollTop,s=m.clientHeight,p=m.scrollHeight;if(q+s+10>p){f=true;i.next(o)}}function n(r){var q=m.querySelectorAll("[selected]");for(var p=0;p<q.length;p++){q[p].removeAttribute("selected")}r.setAttribute("selected",true)}}return{Initialization:e}});cr.view.ticket.Initialization();cr.define("cr.view.document",function(){var b="document";function e(){routerManager.register(/document\//,false,a(c));cr.ui.template.register("doc_template.html");cr.ui.template.register("doc_list_item.html");cr.ui.template.register("doc_detail.html")}function a(f){return function(){cr.view.name=b;cr.ui.changeSelection(b);document.title="Document | Film Society, HKUSTSU";var g=cr.ui.template.render_template("doc_template.html");cr.ui.replaceContent(g,(function(h){f.apply(this,h)}).bind(g,arguments))}}function d(h,i){var g=h.querySelector(".right-panel"),f=g.querySelector(".doc-content-wrapper");g.classList.add("loading");cr.model.Document.get(i,function(j){setTimeout(function(){document.title=j.title+" | Film Society, HKUSTSU";f.setAttribute("hidden",true);while(f.firstChild){f.removeChild(f.firstChild)}var k=cr.ui.template.render_template("doc_detail.html",{doc:j,base_url:cr.settings.resource_base+"upload/"});f.appendChild(k);f.removeAttribute("hidden");setTimeout(function(){g.classList.remove("loading")},0)},410)})}function c(){var h=this,m=this.querySelector(".left-panel .doc-list-wrapper"),j=m.querySelector(".anchor"),g=this.querySelector(".right-panel"),i=new cr.Pager(cr.model.Document,"/"),f=true,k=true;m.addEventListener("scroll",l);i.load(n);function n(p){if(p.length===0||!this.has_next){m.removeChild(j);m.removeEventListener("scroll",l)}for(var o=0;o<p.length;o++){var q=cr.ui.template.render_template("doc_list_item.html",{doc:p[o]});q.addEventListener("click",d.bind(null,h,p[o].id));m.appendChild(q);setTimeout((function(){this.classList.remove("loading")}).bind(q),o*50);if(k&&o==0){d(h,p[o].id)}}k=false;f=false}function l(q){if(f){return}q.preventDefault();q.stopImmediatePropagation();var p=m.scrollTop,r=m.clientHeight,o=m.scrollHeight;if(p+r+10>o){f=true;i.next(n)}}}return{Initialization:e}});cr.view.document.Initialization();cr.define("cr.view.sponsor",function(){var c="sponsor",a=15*1000,d=new Ziggurat;function f(){routerManager.register(/sponsor\//,false,e(b));cr.ui.template.register("sponsor_template.html");cr.ui.template.register("sponsor_item.html",function(h){var g=this;img=g.querySelector("img");img.onload=function(){g.style.width=this.width+"px"};img.onerror=function(){g.style.display="none"};img.src=h.base_url+h.sponsor.img_url.url})}function e(g){return function(){cr.view.name=c;cr.ui.changeSelection(c);document.title="Sponsor | Film Society, HKUSTSU";var h=cr.ui.template.render_template("sponsor_template.html");cr.ui.replaceContent(h,(function(i){g.apply(this,i)}).bind(h,arguments))}}function b(){var h=this,i=new cr.Pager(cr.model.Sponsor,"/"),n=0,o=0;i.load(k);var m=function(q){var p=q.target;p.classList.remove("moving");if(o<a){j.call(p,p.offset)}else{j.call(p,o+p.offset)}};h.addEventListener("webkitAnimationEnd",m);h.addEventListener("MSAnimationEnd",m);h.addEventListener("oAnimationEnd",m);h.addEventListener("animationend",m);function k(r){var p=l(r);h.classList.remove("loading");for(var q=0;q<p.length;q++){var s=cr.ui.template.render_template("sponsor_item.html",{sponsor:p[q],base_url:cr.settings.resource_base+"upload/"});h.appendChild(s);j.call(s,o);if(n==0){o+=a/4}}if(this.has_next){this.next(k)}}function j(q){var r=g(q+1000,Math.min(2000,2*Math.max(q+1000,0))),p=this;p.style.top=g(n*23+6,12)+"%";p.style.zIndex=~~(Math.random()*10);p.offset=q+1000-r;setTimeout((function(){this.classList.add("moving")}).bind(p),r);n++;if(n>3){n=0}}function g(p,q){while(true){var r=d.nextGaussian();r*=q/8;r+=p;if(r<p-(q>>1)||r>p+(q>>1)){continue}return r}}function l(s){var r=s.length,q,p;while(0!==r){p=Math.floor(Math.random()*r);r-=1;q=s[r];s[r]=s[p];s[p]=q}return s}}return{Initialization:f}});cr.view.sponsor.Initialization();cr.define("cr.ui",function(){function b(d,g,c,f){var e=this;e.cx=3*d;e.bx=3*(c-d)-e.cx;e.ax=1-e.cx-e.bx;e.cy=3*g;e.by=3*(f-g)-e.cy;e.ay=1-e.cy-e.by}b.prototype={getX:function(c){return((this.ax*c+this.bx)*c+this.cx)*c},getY:function(c){return((this.ay*c+this.by)*c+this.cy)*c},getDerivativeX:function(c){return(3*this.ax*c+2*this.bx)*c+this.cx},solveAtX:function(c,l){assert(c>=0&&c<=1,"x out of range");var j,h,g,f;for(g=c,f=0;f<8;f++){var e=this.getX(g)-c;if(e<l&&e>-l){return g}var k=this.getDerivativeX(g);if(k<0.000001&&k>-0.000001){break}g-=e/k}j=0;h=1;g=c;while(j<h){var e=this.getX(g);if(e-c<l&&e-c>-l){return g}if(c>e){j=g}else{h=g}g=(h-j)/2+j}return g},solve:function(c,d){if(c<0){return 0}if(c>1){return 1}return this.getY(this.solveAtX(c,d))}};function a(c){this.elem=c;this.lastTick=null;this.lastT=0;this.scrolling=false;this.toX=null;this.toY=null;this.sX=null;this.sY=null;this.dT=null;this.generator=null;this.cbk=null}a.prototype={scrollTo:function(g,f,e,c,d){this.toX=g;this.toY=f;this.sX=this.elem.scrollLeft;this.sY=this.elem.scrollTop;this.lastT=0;this.dT=1/e;this.generator=d;this.cbk=c;if(!this.scrolling){this.scrolling=true;requestAnimationFrame(this.handleScroll.bind(this))}},handleScroll:function(d){if(this.lastT>=1){this.elem.scrollLeft=this.toX;this.elem.scrollTop=this.toY;this.cbk&&this.cbk();this.reset();return}if(!this.scrolling){return}if(this.lastTick==null){this.lastTick=d}var c=this.generator.solve(this.lastT,0.005);this.elem.scrollLeft=this.sX+(this.toX-this.sX)*c;this.elem.scrollTop=this.sY+(this.toY-this.sY)*c;this.lastT+=(d-this.lastTick)*this.dT;this.lastTick=d;cr.dispatchSimpleEvent(this.elem,"scroll",true,true);requestAnimationFrame(this.handleScroll.bind(this))},reset:function(){this.lastTick=null;this.lastT=0;this.scrolling=false;this.toX=null;this.toY=null;this.sX=null;this.sY=null;this.dT=null;this.generator=null;this.cbk=null}};return{UnitBezier:b,Scroller:a}});cr.define("cr.view.news",function(){var d="news";var c=new Array("Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec");function g(){routerManager.register(/home\//,true,f(e));routerManager.register(/news\/(\d+)\//,false,f(b));cr.ui.template.register("news_template.html");cr.ui.template.register("home_template.html");cr.ui.template.register("home_news_item.html",function(h){this.addEventListener("click",(function(i){routerManager.pushState("news/"+i+"/",false,true);a(document.querySelector(".news-wrapper"),b,[i])}).bind(null,h.news.id))});cr.ui.template.register("news_detail.html",function(){this.querySelector(".link-goback").addEventListener("click",function(){if(history.length>1){history.go(-1)}else{routerManager.pushState("home",false,true);a(document.querySelector(".news-wrapper"),e,[{}])}})})}function f(h){return function(){if(cr.view.name!==d){document.title="Home | Film Society, HKUSTSU";var i=cr.ui.template.render_template("news_template.html");cr.ui.replaceContent(i,(function(j){cr.view.name=d;cr.ui.changeSelection(d);h.apply(this,j)}).bind(i,arguments))}else{a(document.querySelector(".news-wrapper"),h,arguments)}}}function a(i,j,k){var h=i.querySelector(".news-content-wrapper");i.classList.add("loading");setTimeout(function(){h.setAttribute("hidden",true);while(h.firstChild){h.removeChild(h.firstChild)}j.apply(i,k)},210)}function e(){var i=this,k=this.querySelector(".news-content-wrapper"),h=new cr.Pager(cr.model.News,"/?limit=15"),j=new Image(),l=cr.model.SiteSettings.getField("header_image").value;j.onload=function(){var u=cr.ui.template.render_template("home_template.html",{url:this.src});k.appendChild(u);k.removeAttribute("hidden");setTimeout(function(){i.classList.remove("loading")},0);var s=true,p=u.querySelector(".news-list"),n=p.querySelector(".anchor");var r=k.clientHeight,o=this.height*u.querySelector(".home-cover-wrapper").clientWidth/this.width,t=o-(r>>1);if(t>0){u.addEventListener("scroll",q);u.addEventListener("mousewheel",q);u.classList.add("scrolling");var m=new cr.ui.Scroller(u);setTimeout(m.scrollTo.bind(m,0,t,3000,function(){u.removeEventListener("scroll",q);u.removeEventListener("mousewheel",q);u.addEventListener("scroll",v);u.classList.remove("scrolling");h.load(w)},new cr.ui.UnitBezier(0.5,0,0.6,1)),700)}else{h.load(w);u.addEventListener("scroll",v)}function q(x){x.preventDefault();x.stopImmediatePropagation()}function w(A){for(var z=0;z<A.length;z++){var x=new Date(toISODate(A[z].create_log.created_at)),y=c[x.getMonth()]+" "+pad(x.getDate(),2),C=pad(x.getHours(),2)+":"+pad(x.getMinutes(),2),B=cr.ui.template.render_template("home_news_item.html",{news:A[z],date:y,time:C});p.insertBefore(B,n);setTimeout((function(){this.classList.remove("loading")}).bind(B),100*z)}if(!this.has_next){p.removeChild(n);u.removeEventListener("scroll",v)}s=false}function v(z){if(s){return}z.preventDefault();z.stopImmediatePropagation();var y=u.scrollTop,A=u.clientHeight,x=u.scrollHeight;if(y+A+10>x){s=true;h.next(w)}}};j.onerror=function(){cr.errorHandler({recObj:{errno:500,error:"Unable to load"}})};cr.model.File.get(l,function(m){j.src=cr.settings.resource_base+"upload/"+m.url})}function b(j){var h=this,i=this.querySelector(".news-content-wrapper");cr.model.News.get(j,function(k){var l=cr.ui.template.render_template("news_detail.html",{news:k});cr.ui.bbcode.handleHTML(l.querySelector(".news-content"));i.appendChild(l);i.removeAttribute("hidden");setTimeout(function(){h.classList.remove("loading")},0)})}return{Initialization:g}});cr.view.news.Initialization();cr.define("cr.ui.rotator",function(){var h=600,c=800,m=24,d=13,e="ontouchstart" in document.documentElement,k=null;function l(){document.addEventListener(e?"touchend":"mouseup",i);document.addEventListener(e?"touchmove":"mousemove",a)}function n(o){o.addEventListener(e?"touchstart":"mousedown",j.bind(o));o.rotFrame=o.rotLastFrame=0;o.rotating=false}function j(o){if(!e&&o.button!=0){return false}this.rotDragging=true;k=this;document.body.classList.add("dragging");if(this.rotCoords==null){this.rotCoords=b(o)}this.offset=0;o.preventDefault();o.stopImmediatePropagation();return false}function a(o){if(!k){return false}var p=f(o,k.rotCoords);g(p);return true}function i(o){if(!k){return false}k.rotLastFrame=k.rotFrame;k.rotCoords=null;document.body.classList.remove("dragging");k=null;return true}function b(o){if(e){o=o.touches[0]}if(o.pageX&&o.pageY){return{x:o.pageX,y:o.pageY}}return{x:o.clientX+(document.body.scrollLeft-document.body.clientLeft),y:o.clientY+(document.body.scrollTop-document.body.clientTop)}}function f(q,p){var o=b(q);return{x:o.x-p.x,y:o.y-p.y}}function g(q){var p=k.rotLastFrame||0,o;o=p+Math.round(q.x/d);if(o>=m||o<0){o=o-(m*Math.floor(o/m))}k.rotFrame=o;k.style.backgroundPosition=(100*o/(m-1))+"% 0%"}return{Initialization:l,init:n}});cr.ui.rotator.Initialization();cr.define("cr.view.about",function(){var b="about",d=10;function f(){routerManager.register(/about\//,false,a(c));cr.ui.template.register("aboutus_template.html");cr.ui.template.register("aboutus_list_item.html");cr.ui.template.register("aboutus_detail_wrapper.html",function(h){var g=this.querySelector(".aboutus-image");cr.ui.rotator.init(g)});cr.ui.template.register("aboutus_society.html")}function a(g){return function(){var h=cr.ui.template.render_template("aboutus_template.html");cr.ui.replaceContent(h,(function(i){cr.ui.changeSelection(b);cr.view.name=b;document.title="About Us | Film Society, HKUSTSU";g.apply(this,i)}).bind(h,arguments))}}function e(i,j){var h=i.querySelector(".left-panel"),g=h.querySelector(".item-info-wrapper");h.classList.add("loading");if(j!==0){cr.model.Exco.get(j,function(k){setTimeout(function(){document.title=k.name_ch+" "+k.name_en+" | Film Society, HKUSTSU";g.setAttribute("hidden",true);while(g.firstChild){g.removeChild(g.firstChild)}var m=cr.ui.template.render_template("aboutus_detail_wrapper.html",{exco:k});g.appendChild(m);g.removeAttribute("hidden");var l=new Image(),n=m.querySelector(".aboutus-image");l.onload=(function(o){n.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+o.img_url.url+")";h.classList.remove("loading")}).bind(null,k);l.onerror=function(){h.classList.remove("loading")};l.src=cr.settings.resource_base+"upload/"+k.img_url.url},60)})}else{setTimeout(function(){document.title="About Us | Film Society, HKUSTSU";g.setAttribute("hidden",true);while(g.firstChild){g.removeChild(g.firstChild)}var k=cr.ui.template.render_template("aboutus_society.html");g.appendChild(k);g.removeAttribute("hidden");setTimeout(function(){h.classList.remove("loading")},0)},60)}}function c(){var i=this,q=this.querySelector(".left-panel"),h=this.querySelector(".right-panel"),o=h.querySelector(".aboutus-list-wrapper"),j=new cr.Pager(cr.model.Exco,"/"),n=new cr.ui.Scroller(h);j.load(l);function l(u){var w=cr.ui.template.render_template("aboutus_list_item.html",{exco:{position:"Film Society, HKUSTSU",name_ch:"Session 2013-2014"}});o.appendChild(w);w.addEventListener("click",(function(x){e(x,0);p(this)}).bind(w,i));for(var t=0;t<u.length;t++){var v=cr.ui.template.render_template("aboutus_list_item.html",{exco:u[t]});v.addEventListener("click",(function(x,y){e(x,y);p(this)}).bind(v,i,u[t].id));o.appendChild(v)}r();var s=o.querySelectorAll(".aboutus-list-item");for(var t=0;t<s.length;t++){setTimeout((function(){this.classList.remove("loading")}).bind(s[t]),100*t+50)}h.addEventListener("scroll",m);q.addEventListener("mouseover",g);setTimeout((function(){e(i,0);p(this)}).bind(w),200)}function r(){var y=k(),t=y[0]?y[0].clientHeight:0,z=h.clientHeight,A=(z>>1)+t,w=h.scrollTop-(t>>1);for(var x=0;x<y.length;x++){var B=y[x],s=w-B.offsetTop,v=Math.abs(s),u="translateX("+((B.getAttribute("selected")?10:20)+(10*v/A))+"%) scale(1)";B.style.webkitTransform=u;B.style.MozTransform=u;B.style.msTransform=u;B.style.OTransform=u;B.style.transform=u;B.style.marginBottom=(-0.5+(0.5*s/A))+"em"}}function k(){var u=h.clientHeight,z=h.scrollTop-(u>>1),v=z+u,t=o.querySelectorAll(".aboutus-list-item"),x=t[0].clientHeight,w=0,y,s;for(y=0;w<z&&y<t.length;y++){w+=x}for(s=y;w<=v&&s<t.length;s++){w+=x}return Array.prototype.slice.call(t,Math.max(0,y-1),s+1)}function m(s){r()}function g(){var t=o.querySelector("[selected]");var u=t.clientHeight,s=t.offsetTop+(u>>1);n.scrollTo(0,s,500,null,new cr.ui.UnitBezier(0.5,0,0.6,1))}function p(v){var u=o.querySelectorAll("[selected]");for(var t=0;t<u.length;t++){u[t].removeAttribute("selected")}v.setAttribute("selected",true);var w=v.clientHeight,s=v.offsetTop+(w>>1);n.scrollTo(0,s,500,null,new cr.ui.UnitBezier(0.5,0,0.6,1));r()}}return{Initialization:f}});cr.view.about.Initialization();cr.define("cr.view.publication",function(){var b="publication";function f(){routerManager.register(/publication\//,false,d(e));cr.ui.template.register("pub_template.html",function(){var h=this.querySelector(".left-panel");left_rotator=h.querySelectorAll(".btn-rotate-left"),right_rotator=h.querySelectorAll(".btn-rotate-right");h.face_idx=1;h.rot=0;for(var g=0;g<left_rotator.length;g++){left_rotator[g].addEventListener("click",function(){h.rot+=120;h.face_idx=(h.face_idx+1)%3;var i="translateX("+(25*h.face_idx-25)+"%) rotateY("+h.rot+"deg)";h.style.webkitTransform=i;h.style.MozTransform=i;h.style.msTransform=i;h.style.OTransform=i;h.style.transform=i})}for(var g=0;g<right_rotator.length;g++){right_rotator[g].addEventListener("click",function(){h.rot-=120;h.face_idx=(h.face_idx+2)%3;var i="translateX("+(25*h.face_idx-25)+"%) rotateY("+h.rot+"deg)";h.style.webkitTransform=i;h.style.MozTransform=i;h.style.msTransform=i;h.style.OTransform=i;h.style.transform=i})}});cr.ui.template.register("pub_list_item.html",function(h){var g=this.querySelector(".publication-cover");g.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+h.publication.cover_url.url+")"});cr.ui.template.register("pub_magazine.html");cr.ui.template.register("pub_micromagazine.html");cr.ui.template.register("pub_podcast.html",function(m){var j=this,h=j.querySelector(".podcast-player"),k=j.querySelector(".podcast-time .podcast-played"),g=j.querySelector(".podcast-control-wrapper"),i=g.querySelector(".podcast-cover"),l=g.querySelector(".podcast-play");i.style.backgroundImage="url("+cr.settings.resource_base+"upload/"+m.publication.cover_url.url+")";l.addEventListener("click",function(){if(this.classList.contains("loading")){return}if(h.ended){h.currentTime=0;h.play();g.classList.add("playing")}else{if(h.paused){h.play();g.classList.add("playing")}else{h.pause();g.classList.remove("playing")}}});h.addEventListener("canplay",function(){h.play();l.classList.remove("loading");g.classList.add("playing")});h.addEventListener("stalled",function(){l.classList.add("loading");g.classList.remove("playing")});h.addEventListener("ended",function(){g.classList.remove("playing")});h.addEventListener("durationchange",function(n){j.querySelector(".podcast-time .podcast-duration").textContent=pad(~~(this.duration/60),2)+":"+pad((~~(this.duration))%60,2)});h.addEventListener("timeupdate",function(n){k.textContent=pad(~~(this.currentTime/60),2)+":"+pad((~~(this.currentTime))%60,2)});h.addEventListener("error",function(){if(h.networkState===HTMLMediaElement.NETWORK_NO_SOURCE){h.load()}});h.src=m.publication.ext_doc_url})}function d(g){return function(){var h=cr.ui.template.render_template("pub_template.html");cr.ui.replaceContent(h,(function(i){cr.ui.changeSelection(b);cr.view.name=b;g.apply(this,i)}).bind(h,arguments))}}function a(i,j){var h=i.querySelector(".right-panel"),g=h.querySelector(".publication-content-wrapper");h.classList.add("loading");cr.model.Publication.get(j,function(k){setTimeout(function(){document.title=k.title+" | Film Society, HKUSTSU";g.setAttribute("hidden",true);while(g.firstChild){g.removeChild(g.firstChild)}var l;switch(k.Type){case"Magazine":l=cr.ui.template.render_template("pub_magazine.html",{publication:k,base_url:cr.settings.resource_base+"upload/"});break;case"MicroMagazine":l=cr.ui.template.render_template("pub_micromagazine.html",{publication:k});break;case"Podcast":l=cr.ui.template.render_template("pub_podcast.html",{publication:k});break}g.appendChild(l);g.removeAttribute("hidden");setTimeout(function(){h.classList.remove("loading")},0)},410)})}function e(i){var g=this,h=g.querySelector(".left-panel");list_magazine_wrapper=h.querySelector(".publication-magazine-list-wrapper"),list_micromagazine_wrapper=h.querySelector(".publication-micromagazine-list-wrapper"),list_podcast_wrapper=h.querySelector(".publication-podcast-list-wrapper"),panel=g.querySelector(".right-panel");c(list_magazine_wrapper,new cr.Pager(cr.model.Publication,"/?Type=Magazine"),function(l,j){var k=cr.ui.template.render_template("pub_list_item.html",{publication:l});k.addEventListener("click",(function(o){var n=h.querySelectorAll(".publication-list-item[selected]");for(var m=0;m<n.length;m++){n[m].removeAttribute("selected")}k.setAttribute("selected",true);a(g,o)}).bind(k,l.id));list_magazine_wrapper.appendChild(k);setTimeout((function(){this.classList.remove("loading")}).bind(k),50*j+1);if(j==0&&list_magazine_wrapper.first_load){k.setAttribute("selected",true);a(g,l.id)}});c(list_micromagazine_wrapper,new cr.Pager(cr.model.Publication,"/?Type=MicroMagazine"),function(l,j){var k=cr.ui.template.render_template("pub_list_item.html",{publication:l});k.addEventListener("click",(function(o){var n=h.querySelectorAll(".publication-list-item[selected]");for(var m=0;m<n.length;m++){n[m].removeAttribute("selected")}k.setAttribute("selected",true);a(g,o)}).bind(k,l.id));list_micromagazine_wrapper.appendChild(k);setTimeout((function(){this.classList.remove("loading")}).bind(k),50*j+1)});c(list_podcast_wrapper,new cr.Pager(cr.model.Publication,"/?Type=Podcast"),function(l,j){var k=cr.ui.template.render_template("pub_list_item.html",{publication:l});k.addEventListener("click",(function(o){var n=h.querySelectorAll(".publication-list-item[selected]");for(var m=0;m<n.length;m++){n[m].removeAttribute("selected")}k.setAttribute("selected",true);a(g,o)}).bind(k,l.id));list_podcast_wrapper.appendChild(k);setTimeout((function(){this.classList.remove("loading")}).bind(k),50*j+1)})}function c(j,g,k){j.anchor_element=j.querySelector(".anchor");j.ajax_loading=true;j.first_load=true;j.item_cbk=k;j.addEventListener("scroll",i);g.load(h);function h(m){if(m.length===0||!this.has_next){j.removeChild(j.anchor_element);j.removeEventListener("scroll",i)}for(var l=0;l<m.length;l++){j.item_cbk&&j.item_cbk(m[l],l)}j.first_load=false;j.ajax_loading=false}function i(n){if(this.ajax_loading){return}n.preventDefault();n.stopImmediatePropagation();var m=this.scrollTop,o=this.clientHeight,l=this.scrollHeight;if(m+o+10>l){this.ajax_loading=true;g.next(h)}}}return{Initialization:f}});cr.view.publication.Initialization();